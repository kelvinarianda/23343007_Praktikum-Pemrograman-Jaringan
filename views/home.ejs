<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MarketWave | Financial Terminal</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0f1e;
      --card-bg: #161e31;
      --accent-gold: #fbbf24;
      --pure-white: #ffffff;
      --info-cyan: #22d3ee;
      --border-color: rgba(251, 191, 36, 0.2);
    }

    body {
      background-color: var(--bg-dark);
      color: var(--pure-white);
      font-family: 'Inter', sans-serif;
    }

    .premium-title {
      font-family: 'Playfair Display', serif;
      color: var(--accent-gold);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .card:hover { transform: translateY(-5px); }

    .card-title-gold {
      color: var(--accent-gold);
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      margin-bottom: 15px;
    }

    .display-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--pure-white);
    }

    .unit-text {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.5);
      margin-left: 5px;
    }

    .info-label { font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); }
    .info-data { font-size: 0.75rem; color: var(--info-cyan); }

    .btn-gold {
      background-color: var(--accent-gold);
      color: #000;
      font-weight: 700;
      border: none;
      font-size: 0.8rem;
    }

    #chat {
      background: #0f172a !important;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    /* Berita Card Styling */
    .news-card { border-top: 3px solid var(--accent-gold); }
    .news-title { color: var(--pure-white); font-weight: 700; font-size: 1rem; }
    .news-summary { color: rgba(255,255,255,0.6); font-size: 0.85rem; }
    .news-link { color: var(--info-cyan); font-weight: 600; text-decoration: none; font-size: 0.8rem; }
    .news-link:hover { color: var(--accent-gold); }

    hr { border-color: rgba(255,255,255,0.1); }
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="pb-5">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="premium-title mb-0">MARKET WAVE</h2>
        <div class="small">
          <span class="info-label">Investor:</span> 
          <span class="text-white fw-bold"><%= pengguna ? pengguna.nama : 'Guest' %></span>
          <span class="badge bg-warning text-dark ms-2" style="font-size: 0.6rem;"><%= pengguna ? pengguna.peran : 'visitor' %></span>
        </div>
      </div>
      <div>
        <% if (pengguna) { %>
          <form method="POST" action="/logout"><button class="btn btn-outline-danger btn-sm rounded-pill px-4">Logout</button></form>
        <% } else { %>
          <a href="/login" class="btn btn-outline-gold btn-sm rounded-pill px-4">Login</a>
        <% } %>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">USD/IDR</div>
          <div class="display-value">
            <span id="usdHarga"><%= (typeof usdIdr !== 'undefined' && usdIdr) ? Number(usdIdr).toLocaleString("id-ID") : "-" %></span>
            <span class="unit-text">IDR</span>
          </div>
          <div class="mt-3 pt-3 border-top">
            <div class="info-label">Source: <span class="info-data" id="usdSumber">open.er-api.com</span></div>
            <div class="info-label">Update: <span class="info-data" id="usdUpdate">-</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">EMAS (XAU/USD)</div>
          <div class="display-value">
            <span id="emasHarga"><%= (typeof emas !== 'undefined' && emas?.harga) ? Number(emas.harga).toLocaleString("id-ID") : "-" %></span>
            <span class="unit-text">USD/oz</span>
          </div>
          <div class="mt-3 pt-3 border-top">
            <div class="info-label">Market: <span class="info-data" id="emasSumber">metalpriceapi.com</span></div>
            <div class="info-label">Status: <span class="text-warning fw-bold">Delayed Data</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">BITCOIN (BTC)</div>
          <div class="display-value">
            <span id="btcHarga">-</span>
            <span class="unit-text">USD</span>
          </div>
          <div class="mt-3 pt-3 border-top">
            <div class="info-label">Market: <span class="info-data">coingecko.com</span></div>
            <div class="info-label">Updated: <span class="info-data" id="btcUpdate">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="card-title-gold m-0">Gold Price Analysis</div>
            <div class="d-flex gap-2">
              <select id="pilihHari" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: 80px;">
                <option value="7">7D</option>
                <option value="14">14D</option>
                <option value="30">30D</option>
              </select>
              <button id="btnMuatChart" class="btn btn-gold btn-sm px-3">Refresh</button>
            </div>
          </div>
          <div style="height: 300px;">
            <canvas id="chartEmas"></canvas>
          </div>
          <div id="statusChartEmas" class="info-label mt-3 text-center">System Analysis: Ready</div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-4 h-100">
          <div class="card-title-gold">IHSG (IDX Composite)</div>
          <iframe
            src="https://www.tradingview.com/widgetembed/?symbol=IDX%3ACOMPOSITE&interval=D&theme=dark&style=1&hide_legend=true"
            style="width:100%; height:320px;"
            frameborder="0">
          </iframe>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12">
        <div class="card p-4 shadow-lg">
          <div class="card-title-gold">Wave AI Intelligence</div>
          <div id="chat" class="p-3 mb-3" style="height: 250px; overflow-y:auto; color: white; font-size: 0.9rem;">
            <div class="text-muted small italic">System initialized... Awaiting terminal command.</div>
          </div>
          <div class="input-group">
            <input id="inputPesan" class="form-control bg-dark text-white border-secondary py-3" placeholder="Analyze market trends..." />
            <button id="btnKirim" class="btn btn-gold px-5">SEND</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="premium-title mb-0" style="font-size: 1.2rem;">Market Insights</h4>
          <hr class="flex-grow-1 mx-3">
        </div>
      </div>

      <% if (!berita || berita.length === 0) { %>
        <div class="col-12">
          <div class="alert bg-dark text-warning border-warning opacity-75">No recent market insights available.</div>
        </div>
      <% } else { %>
        <% (berita || []).forEach(b => { %>
          <div class="col-md-4">
            <div class="card h-100 news-card overflow-hidden">
              <img src="<%= b.gambar %>" alt="insight" style="width:100%; height: 160px; object-fit: cover; opacity: 0.8;">
              <div class="card-body">
                <div class="news-title mb-2"><%= b.judul %></div>
                <p class="news-summary"><%= b.ringkasan %></p>
                <a href="/berita/<%= b.slug %>" class="news-link">READ ANALYSIS â†’</a>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>

  </div>

<script>
  let chartInstance = null;
  const ctx = document.getElementById('chartEmas').getContext('2d');

  async function muatChart(hari = 7) {
    try {
      const res = await fetch(`/api/public/emas/riwayat?hari=${hari}`);
      const json = await res.json();
      if (!json.ok) return;

      let labels = [], series = [];
      if (json.data?.rates) {
        labels = Object.keys(json.data.rates).sort();
        series = labels.map(tgl => 1 / (json.data.rates[tgl].XAU || 1));
      } else if (json.data_histori) {
        labels = json.data_histori.map(x => x.tanggal);
        series = json.data_histori.map(x => x.harga_usd_per_oz);
      }

      if (chartInstance) chartInstance.destroy();
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(251, 191, 36, 0.4)');
      gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'XAU/USD',
            data: series,
            borderColor: '#fbbf24',
            borderWidth: 3,
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#fbbf24'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } } },
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } } }
          }
        }
      });
      document.getElementById("statusChartEmas").textContent = `SYSTEM ANALYSIS: ${hari} DAYS COMPLETED`;
    } catch (e) { console.error(e); }
  }

  async function refreshData() {
    fetch("/api/public/usd-idr").then(r => r.json()).then(j => {
      if(j.ok) {
        document.getElementById("usdHarga").textContent = Number(j.data.idr).toLocaleString("id-ID");
        document.getElementById("usdUpdate").textContent = j.data.waktu_update;
      }
    });
    fetch("/api/public/bitcoin/latest").then(r => r.json()).then(j => {
      if(j.ok) {
        document.getElementById("btcHarga").textContent = Number(j.data.usd).toLocaleString("id-ID");
        document.getElementById("btcUpdate").textContent = new Date().toLocaleTimeString();
      }
    });
    fetch("/api/public/emas/latest").then(r => r.json()).then(j => {
      if(j.ok) {
        document.getElementById("emasHarga").textContent = Number(j.data.hargaUsdPerOz).toLocaleString("id-ID");
      }
    });
  }

  const socket = io();
  const btnKirim = document.getElementById("btnKirim");
  const inputPesan = document.getElementById("inputPesan");
  const chatBox = document.getElementById("chat");

  btnKirim.onclick = () => {
    const msg = inputPesan.value;
    if(!msg) return;
    chatBox.innerHTML += `<div class="mb-2"><b style="color:#fbbf24">USER:</b> ${msg}</div>`;
    socket.emit("pesan_user", { id_pengguna: "<%= pengguna ? pengguna.id : 'guest' %>", pesan: msg });
    inputPesan.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  socket.on("jawaban_bot", (data) => {
    chatBox.innerHTML += `<div class="mb-2"><b style="color:#22d3ee">WAVE-AI:</b> ${data.jawaban}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  document.getElementById("btnMuatChart").onclick = () => muatChart(document.getElementById("pilihHari").value);
  muatChart(7);
  refreshData();
  setInterval(refreshData, 60000);
</script>
</body>
</html>