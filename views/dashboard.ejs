<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MarketWave | Premium Investment Dashboard</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0f1e; /* Sama dengan home.ejs */
      --card-bg: #161e31; /* Sama dengan home.ejs */
      --accent-gold: #fbbf24;
      --pure-white: #ffffff;
      --info-cyan: #22d3ee;
      --border-color: rgba(251, 191, 36, 0.2);
    }

    body {
      background-color: var(--bg-dark);
      color: var(--pure-white);
      font-family: 'Inter', sans-serif;
    }

    .premium-title {
      font-family: 'Playfair Display', serif;
      color: var(--accent-gold);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    /* Penyesuaian Label/Judul di dalam Kartu */
    .card-title-gold {
      color: var(--accent-gold);
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      margin-bottom: 15px;
    }

    .display-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--pure-white);
    }

    .unit-text {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.5);
      margin-left: 5px;
    }

    .info-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .info-data {
      font-size: 0.75rem;
      color: var(--info-cyan); /* Warna cyan dari home.ejs */
    }

    .btn-gold {
      background-color: var(--accent-gold);
      color: #000;
      font-weight: 700;
      border: none;
      font-size: 0.8rem;
    }

    .btn-outline-gold {
      border: 1px solid var(--accent-gold);
      color: var(--accent-gold);
      font-size: 0.8rem;
    }

    #chat {
      background: #0f172a !important;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .form-control, .form-select {
      background-color: #0a0f1e;
      border: 1px solid var(--border-color);
      color: white;
    }

    .news-card-img {
      filter: grayscale(20%) brightness(80%);
      transition: 0.3s;
      border-bottom: 3px solid var(--accent-gold);
    }

    hr { border-color: rgba(255, 255, 255, 0.1); }
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="pb-5">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-5">
      <div>
        <h2 class="premium-title mb-0">MARKET WAVE</h2>
        <div class="small">
          <span class="info-label">Investor:</span> 
          <span class="text-white fw-bold"><%= pengguna.nama %></span> 
          <span class="badge bg-warning text-dark ms-2" style="font-size: 0.6rem;"><%= pengguna.peran %></span>
        </div>
      </div>
      <form method="POST" action="/logout" class="m-0">
        <button class="btn btn-outline-danger btn-sm rounded-pill px-4">Logout</button>
      </form>
    </div>

    <div class="row g-3">
      <% kartu.forEach(k => { %>
        <div class="col-md-4">
          <div class="card p-4 h-100">
            <div class="card-title-gold"><%= k.nama %></div>
            <div class="display-value">
              <span id="kartu_<%= k.key %>">
                <%= (k.harga !== null && k.harga !== undefined) ? Number(k.harga).toLocaleString("id-ID") : "-" %>
              </span>
              <span class="unit-text"><%= k.satuan %></span>
            </div>
            <div class="mt-3 pt-3 border-top border-secondary">
              <div class="info-label">Source: <span class="info-data" id="kartuSumber_<%= k.key %>"><%= k.sumber %></span></div>
              <div class="info-label">Update: <span class="info-data" id="kartuUpdate_<%= k.key %>"><%= k.waktu_update %></span></div>
            </div>
          </div>
        </div>
      <% }) %>

      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">Emas (XAU/USD)</div>
          <div class="display-value">
            <span id="emasHarga">-</span>
            <span class="unit-text">USD/oz</span>
          </div>
          <div class="mt-3 pt-3 border-top border-secondary">
            <div class="info-label">Market: <span class="info-data" id="emasSumber">metalpriceapi.com</span></div>
            <div class="info-label">Status: <span class="text-warning fw-bold">Delayed Data</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">Bitcoin (BTC)</div>
          <div class="display-value">
            <span id="btcHarga">-</span>
            <span class="unit-text">USD</span>
          </div>
          <div class="mt-3 pt-3 border-top border-secondary">
            <div class="info-label">Market: <span class="info-data" id="btcSumber">coingecko.com</span></div>
            <div class="info-label">Updated: <span class="info-data" id="btcUpdate">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-3">
      <div class="col-lg-6">
        <div class="card p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="card-title-gold m-0">Gold Price Analysis</div>
            <div class="d-flex gap-2">
              <select id="pilihHari" class="form-select form-select-sm">
                <option value="7" selected>7D</option>
                <option value="14">14D</option>
                <option value="30">30D</option>
              </select>
              <button id="btnMuatChart" class="btn btn-gold btn-sm px-3">Refresh</button>
            </div>
          </div>
          <div style="height: 300px;">
            <canvas id="chartEmas"></canvas>
          </div>
          <div id="statusChartEmas" class="info-label mt-3 text-center">System Analysis: Ready</div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-4 h-100">
          <div class="card-title-gold">IHSG (IDX Composite)</div>
          <iframe
            src="https://www.tradingview.com/widgetembed/?symbol=IDX%3ACOMPOSITE&interval=D&theme=dark&style=1&hide_legend=true"
            style="width:100%; height:320px;"
            frameborder="0">
          </iframe>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-3">
      <div class="col-lg-8">
        <div class="card p-4 shadow-lg">
          <div class="card-title-gold">Wave AI Intelligence</div>
          <div id="chat" class="p-3 mb-3" style="height: 350px; overflow-y:auto; color: white;"></div>
          <div class="input-group">
            <input id="inputPesan" class="form-control py-3" placeholder="Analyze market trends..." />
            <button id="btnKirim" class="btn btn-gold px-5">SEND</button>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-4 h-100">
          <div class="card-title-gold">Terminal Reports</div>
          <p class="info-label">Send market analysis and AI discussion logs directly to your registered email.</p>
          <button id="btnEmail" class="btn btn-outline-gold w-100 py-3 mb-3">
             SEND REPORT TO EMAIL
          </button>
          <div id="statusEmail" class="text-center small info-data"></div>
          
          <div class="mt-auto pt-3 border-top border-secondary">
             <div class="info-label text-center">System Integrated: <span class="info-data">MongoDB & AI Cloud</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="premium-title mb-0" style="font-size: 1.2rem;">Market Insight</h4>
        <hr class="flex-grow-1 mx-3">
        <% if (pengguna?.peran === "admin") { %>
          <a class="btn btn-gold btn-sm" href="/admin/berita">Manage</a>
        <% } %>
      </div>

      <% if (!beritaTerbaru || beritaTerbaru.length === 0) { %>
        <div class="alert bg-dark text-warning border-warning">No recent insights available.</div>
      <% } else { %>
        <div class="row g-4">
          <% beritaTerbaru.forEach(b => { %>
            <div class="col-md-4">
              <a href="/berita/<%= b.slug %>" class="text-decoration-none h-100">
                <div class="card h-100 overflow-hidden" style="background: transparent; border: none;">
                  <% if (b.gambar) { %>
                    <img src="<%= b.gambar %>" class="news-card-img rounded-3" style="width:100%; height:180px; object-fit:cover;">
                  <% } %>
                  <div class="card-body px-0">
                    <h6 class="text-white fw-bold mb-2"><%= b.judul %></h6>
                    <p class="info-label mb-3">
                      <%= (b.ringkasan || "").slice(0, 80) %>...
                    </p>
                    <span class="info-data fw-bold">READ ANALYSIS →</span>
                  </div>
                </div>
              </a>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>

    <footer class="mt-5 text-center info-label">
      <p>© 2025 Market Wave | Premium Financial Terminal</p>
    </footer>

  </div>

<script>
  // Logika script tetap sama, hanya menyesuaikan pemanggilan selector jika ada perubahan ID
  const idPengguna = "<%= pengguna.id %>";
  const socket = io();

  const chat = document.getElementById("chat");
  const inputPesan = document.getElementById("inputPesan");
  const btnKirim = document.getElementById("btnKirim");
  const btnEmail = document.getElementById("btnEmail");
  const statusEmail = document.getElementById("statusEmail");

  function tambahPesan(pihak, teks) {
    const div = document.createElement("div");
    div.className = "mb-3 pb-2 border-bottom border-dark";
    const color = pihak === "User" ? "#fbbf24" : "#22d3ee";
    div.innerHTML = `<span class="fw-bold" style="color:${color}">${pihak.toUpperCase()}:</span> <span class="ms-2">${teks}</span>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  btnKirim.addEventListener("click", () => {
    const pesan = inputPesan.value.trim();
    if (!pesan) return;
    tambahPesan("User", pesan);
    socket.emit("pesan_user", { id_pengguna: idPengguna, pesan });
    inputPesan.value = "";
  });

  inputPesan.addEventListener("keydown", (e) => { if (e.key === "Enter") btnKirim.click(); });

  socket.on("jawaban_bot", (data) => {
    tambahPesan("AI", data?.jawaban || "No response.");
  });

  btnEmail.addEventListener("click", async () => {
    statusEmail.textContent = "Processing...";
    const res = await fetch("/email/ringkasan", { method: "POST" });
    const json = await res.json().catch(()=>({ok:false,pesan:"Error"}));
    statusEmail.textContent = json.pesan || (json.ok ? "Success" : "Failed");
  });

  function fmtAngkaID(n, maxFrac = 2) {
    return Number(n).toLocaleString("id-ID", { maximumFractionDigits: maxFrac });
  }

  // API FETCH
  async function refreshDashboard() {
    // USD IDR
    fetch("/api/public/usd-idr").then(r => r.json()).then(j => {
      if (j.ok) {
        const el = document.getElementById("kartu_usd_idr");
        if(el) el.textContent = fmtAngkaID(j.data.idr, 0);
      }
    });

    // Emas
    fetch("/api/public/emas/latest").then(r => r.json()).then(j => {
      if (j.ok) {
        document.getElementById("emasHarga").textContent = fmtAngkaID(j.data.hargaUsdPerOz, 2);
      }
    });

    // Bitcoin
    fetch("/api/public/bitcoin/latest").then(r => r.json()).then(j => {
      if (j.ok) {
        document.getElementById("btcHarga").textContent = fmtAngkaID(j.data.usd, 0);
        document.getElementById("btcUpdate").textContent = new Date().toLocaleTimeString();
      }
    });
  }

  // CHART
  let chartEmasInstance = null;
  async function muatChartEmas(hari = 7) {
    try {
      const res = await fetch(`/api/public/emas/riwayat?hari=${hari}`);
      const json = await res.json();
      if (!json.ok) return;

      let labels = [], series = [];
      if (json.data?.rates) {
        labels = Object.keys(json.data.rates).sort();
        series = labels.map(tgl => 1 / (json.data.rates[tgl].XAU || 1));
      } else if (json.data_histori) {
        labels = json.data_histori.map(x => x.tanggal);
        series = json.data_histori.map(x => Number(x.harga_usd_per_oz));
      }

      const ctx = document.getElementById("chartEmas").getContext("2d");
      if (chartEmasInstance) chartEmasInstance.destroy();

      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(251, 191, 36, 0.4)');
      gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');

      chartEmasInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "XAU/USD",
            data: series,
            borderColor: "#fbbf24",
            borderWidth: 3,
            backgroundColor: gradient,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: "rgba(255,255,255,0.05)" }, ticks: { color: "rgba(255,255,255,0.5)" } },
            x: { grid: { display: false }, ticks: { color: "rgba(255,255,255,0.5)" } }
          }
        }
      });
    } catch (e) { console.error(e); }
  }

  document.getElementById("btnMuatChart").addEventListener("click", () => muatChartEmas(document.getElementById("pilihHari").value));

  // INIT
  refreshDashboard();
  muatChartEmas(7);
  setInterval(refreshDashboard, 60000);
</script>
</body>
</html>